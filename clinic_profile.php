<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ملف العيادة - kaivet</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #fdfcfa;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23e0c7a3' fill-opacity='0.15'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zM95 86h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zM95 76h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zM95 66h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zM95 56h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zM95 46h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zM95 36h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zM95 26h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zM95 16h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9zm-10 0h-9v9h9v-9z'/%3E%3Cpath d='M15 96v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zM15 86v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zM15 76v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zM15 66v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zM15 56v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zM15 46v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zM15 36v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zM15 26v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zM15 16v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9zm10 0v-9h-9v9h9z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .star-filled { color: #f59e0b; }
         #preloader {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #fff;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* الدائرة حوالين اللوجو */
.preloader-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 3px solid transparent;
    border-top: 2px solid red;       /* بداية التدرج */
    border-right: 2px solid red;    /* نهاية التدرج */
    animation: spin .4s linear infinite;
    position: absolute;
    box-shadow: 0 0 15px rgba(0,0,0,0.05);
}

/* اللوجو */
.preloader-img img {
    width: 90px;
    height: auto;
    border-radius: 50%;
}

/* حركة دوران */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
         .doctor-card {
    background: #fff;
    border-radius: 1rem; /* يعادل 16px، يمكنك زيادة الرقم للمزيد من الدائرية */
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
    overflow: hidden;
    transition: all 0.3s ease;
}
    /* تصميم كارت الطبيب الجديد */
    .doctor-card-image-wrapper {
        position: relative; /* ضروري لتثبيت الصورة بالداخل */
        width: 100%;
        padding-top: 100%; /* هذا يجعل ارتفاع الحاوية مساويًا لعرضها (شكل مربع) */
        background-color: #f1f5f9;
        overflow: hidden;
    }
    .doctor-card-image {
        position: absolute; /* يجعل الصورة تملأ الحاوية */
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover; /* الآن cover آمنة لأن الحاوية مربعة */
        transition: transform 0.4s ease;
    }
    /* ---------------------------------------------------- */

    .doctor-card:hover .doctor-card-image {
        transform: scale(1.05);
    }
    .doctor-card-content {
        padding: 1.5rem;
        text-align: center;
        border-top: 1px solid #f1f5f9;
    }
        /* ستايل النجوم في فورم التقييم */
        .rating-stars { display: inline-flex; flex-direction: row-reverse; }
        .rating-stars input { display: none; }
        .rating-stars label {
            font-size: 2.5rem; color: #cbd5e1; /* slate-300 */
            cursor: pointer; transition: color 0.2s; padding: 0 0.125rem;
        }
        .rating-stars input:checked ~ label,
        .rating-stars label:hover,
        .rating-stars label:hover ~ label { color: #f59e0b; }
        
        #clinic-map { height: 350px; width: 100%; border-radius: 0.75rem; border: 1px solid #e2e8f0; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="preloader">
    <div class="preloader-circle"></div>
    <div class="preloader-img">
        <img src="logo.png" alt="Loading..." />
    </div>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto p-4 flex justify-between items-center max-w-7xl">
            <h1 class="text-2xl font-bold text-sky-700">kaivet Platform</h1>
            <a href="find_clinics.php" class="text-sky-600 hover:text-sky-800 font-semibold flex items-center gap-2">
                <i class="fas fa-search"></i> العودة للبحث
            </a>
        </div>
    </header>

    <div id="page-content" class="container mx-auto p-4 md:p-8 max-w-7xl opacity-0 transition-opacity duration-500">
        
        <div id="loading-error" class="hidden">
             <h1 class="text-center text-3xl font-bold text-rose-600 p-10">خطأ: لم يتم تحديد العيادة.</h1>
        </div>

        <div id="clinic-content-wrapper" class="hidden">
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-200 mb-8">
                <div class="flex flex-col md:flex-row justify-between gap-4">
                    <div>
                        <h1 id="clinic-name" class="text-4xl font-bold text-slate-800">...</h1>
                        <p id="clinic-address" class="text-lg text-slate-600 mt-2"><i class="fas fa-map-marker-alt w-4 ml-2 text-slate-400"></i> ...</p>
                    </div>
                    <a id="whatsapp-button" href="#" target="_blank" class="flex-shrink-0 bg-emerald-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-emerald-600 transition-all duration-200 flex items-center justify-center gap-3">
                        <i class="fab fa-whatsapp text-2xl"></i> تواصل مع العيادة
                    </a>
                </div>
                <div id="clinic-promotions-bar" class="mt-6 space-y-2">
                    </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8">
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-slate-800">موقع العيادة</h2>
                            <a id="get-directions-btn" href="#" target="_blank" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 flex items-center gap-2 transition-all">
                                <i class="fas fa-directions"></i> الحصول على الاتجاهات
                            </a>
                        </div>
                        <div id="clinic-map-container" class="relative">
                            <div id="clinic-map"></div>
                        </div>
                        <p id="map-error" class="text-center text-rose-500 hidden mt-4 p-4 bg-rose-50 rounded-lg">لم تقم العيادة بتسجيل إحداثياتها. (مطلوب لعرض الخريطة والبحث الجغرافي).</p>
                        <p id="map-api-error" class="text-center text-rose-500 hidden mt-4 p-4 bg-rose-50 rounded-lg">فشل تحميل الخريطة. خطأ في مفتاح Google API (BillingNotEnabledMapError).</p>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h2 class="text-2xl font-bold text-slate-800 mb-4">الخدمات المتاحة</h2>
                        <div id="services-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6">الفريق الطبي</h2>
                        <div id="doctors-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h2 class="text-2xl font-bold text-slate-800 mb-4">آراء العملاء عن الأطباء</h2>
                        <div id="doctor-reviews-list" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar pr-2"></div>
                    </div>
                </div>

                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200 sticky top-24">
                        <h2 class="text-2xl font-bold text-slate-800 mb-4">تقييم العيادة</h2>
                        
                        <form id="clinic-review-form" class="space-y-4 mb-6 border-b pb-6">
                            <p class="font-semibold text-center">ما هو تقييمك العام لهذه العيادة؟</p>
                            <div class="rating-stars mx-auto">
                                <input type="radio" id="c-star5" name="clinic_rating" value="5"><label for="c-star5">★</label>
                                <input type="radio" id="c-star4" name="clinic_rating" value="4"><label for="c-star4">★</label>
                                <input type="radio" id="c-star3" name="clinic_rating" value="3"><label for="c-star3">★</label>
                                <input type="radio" id="c-star2" name="clinic_rating" value="2"><label for="c-star2">★</label>
                                <input type="radio" id="c-star1" name="clinic_rating" value="1" required><label for="c-star1">★</label>
                            </div>
                            <div>
                                <label for="clinic-review-name" class="block text-sm font-semibold text-slate-700 mb-1">اسمك</label>
                                <input type="text" id="clinic-review-name" name="name" class="w-full p-3 border border-slate-300 rounded-lg" required>
                            </div>
                            <div>
                                <label for="clinic-review-comment" class="block text-sm font-semibold text-slate-700 mb-1">تعليقك على العيادة</label>
                                <textarea id="clinic-review-comment" name="comment" rows="3" class="w-full p-3 border border-slate-300 rounded-lg"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hover:bg-emerald-700 shadow-md">إرسال تقييم العيادة</button>
                            <div id="clinic-review-message" class="text-center font-semibold hidden mt-2"></div>
                        </form>

                        <h3 class="text-lg font-bold text-slate-700 mb-2">آخر التقييمات للعيادة</h3>
                        <div id="clinic-reviews-list" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar pr-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="review-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[10000] p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-auto">
            <div class="bg-sky-600 text-white p-4 rounded-t-xl flex justify-between items-center">
                <h3 class="text-xl font-bold">إضافة تقييمك للطبيب</h3>
                <button id="close-review-modal" class="text-2xl hover:text-gray-200">×</button>
            </div>
            <form id="doctor-review-form" class="space-y-4 p-6">
                <input type="hidden" id="review-doctor-id" name="doctor_id">
                <p class="font-semibold">أنت تقيّم الآن: <strong id="review-doctor-name" class="text-sky-700"></strong></p>
                <div class="rating-stars">
                    <input type="radio" id="star5" name="doctor_rating" value="5"><label for="star5">★</label>
                    <input type="radio" id="star4" name="doctor_rating" value="4"><label for="star4">★</label>
                    <input type="radio" id="star3" name="doctor_rating" value="3"><label for="star3">★</label>
                    <input type="radio" id="star2" name="doctor_rating" value="2"><label for="star2">★</label>
                    <input type="radio" id="star1" name="doctor_rating" value="1" required><label for="star1">★</label>
                </div>
                <div>
                    <label for="doctor-review-name" class="block text-sm font-semibold text-slate-700 mb-1">اسمك</label>
                    <input type="text" id="doctor-review-name" name="name" placeholder="اكتب اسمك" class="w-full p-3 border border-slate-300 rounded-lg" required>
                </div>
                <div>
                    <label for="doctor-review-comment" class="block text-sm font-semibold text-slate-700 mb-1">رأيك (اختياري)</label>
                    <textarea id="doctor-review-comment" name="comment" rows="3" placeholder="اكتب تجربتك هنا..." class="w-full p-3 border border-slate-300 rounded-lg"></textarea>
                </div>
                <button type="submit" class="w-full bg-sky-600 text-white font-bold py-3 rounded-lg hover:bg-sky-700 shadow-md">إرسال تقييم الطبيب</button>
                <div id="doctor-review-message" class="text-center font-semibold hidden mt-2"></div>
            </form>
        </div>
    </div>
    
    <script>
        function initClinicMap() {
             window.googleMapsApiLoaded = true; 
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOVYRIgupAurZup5y1PRh8Ismb1A3lLao&callback=initClinicMap"></script>

    <script>
        window.googleMapsApiLoaded = false;
        
        function renderStars(rating, small = false) {
            let starsHTML = '';
            const sizeClass = small ? 'text-sm' : 'text-lg';
            const fullStars = Math.floor(rating);
            const halfStar = (rating % 1 >= 0.5) ? 1 : 0;
            const emptyStars = 5 - fullStars - halfStar;
            for(let i = 0; i < fullStars; i++) starsHTML += `<i class="fas fa-star star-filled ${sizeClass}"></i>`;
            if(halfStar) starsHTML += `<i class="fas fa-star-half-alt star-filled ${sizeClass}"></i>`;
            for(let i = 0; i < emptyStars; i++) starsHTML += `<i class="far fa-star text-slate-300 ${sizeClass}"></i>`;
            return `<span class="inline-block align-middle">${starsHTML}</span>`;
        }

        async function loadClinicData(clinicId) {
            const preloader = document.getElementById('preloader');
            const pageContent = document.getElementById('page-content');
            const errorContainer = document.getElementById('loading-error');
            const clinicContent = document.getElementById('clinic-content-wrapper');

            try {
                const response = await fetch(`api/public_portal.php?action=get_clinic_details&id=${clinicId}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.error);
                const data = result.data;

                // 1. ملء معلومات العيادة وزر الواتساب
                document.getElementById('clinic-name').textContent = data.clinic_info.clinic_name || 'عيادة غير مسماة';
                document.getElementById('clinic-address').innerHTML = `<i class="fas fa-map-marker-alt w-4 ml-2 text-slate-400"></i> ${data.clinic_info.clinic_address || 'العنوان غير محدد'}`;
                const whatsappBtn = document.getElementById('whatsapp-button');
                if (data.clinic_info.clinic_whatsapp) {
                    const cleanPhone = data.clinic_info.clinic_whatsapp.replace(/[^0-9+]/g, '');
                    whatsappBtn.href = `https://wa.me/${cleanPhone}`;
                } else {
                    whatsappBtn.classList.add('hidden');
                }

                // 2. تحميل الخريطة وزر الاتجاهات (جديد)
                const lat = parseFloat(data.clinic_info.clinic_lat);
                const lng = parseFloat(data.clinic_info.clinic_lng);
                const directionsBtn = document.getElementById('get-directions-btn');

                if (lat && lng) {
                    // ضبط زر "وجهني" (يفتح جوجل مابس في تاب جديد)
                    directionsBtn.href = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
                    
                    if (!window.googleMapsApiLoaded) {
                        await new Promise(resolve => setTimeout(resolve, 500)); 
                    }

                    if (typeof google !== 'undefined' && typeof google.maps === 'object') {
                        const clinicLocation = { lat: lat, lng: lng };
                        const map = new google.maps.Map(document.getElementById("clinic-map"), {
                            center: clinicLocation, zoom: 16,
                        });
                        new google.maps.Marker({ position: clinicLocation, map: map, title: data.clinic_info.clinic_name });
                    } else {
                         document.getElementById('map-error').classList.add('hidden');
                         document.getElementById('map-api-error').classList.remove('hidden');
                    }
                } else {
                    document.getElementById('map-error').classList.remove('hidden');
                    document.getElementById('get-directions-btn').classList.add('hidden');
                }

                // 3. ملء الخدمات (بالتصميم المبسط الجديد)
                const servicesContainer = document.getElementById('services-list');
                if (data.services && data.services.length > 0) {
                     servicesContainer.innerHTML = data.services.map(s => {
                        let priceDisplay = `<span class="font-semibold text-emerald-600">${s.price_note || 'السعر حسب الحالة'}</span>`;
                        
                        return `
                        <div class="border border-slate-200 rounded-lg p-4 bg-slate-50">
                            <h5 class="font-bold text-slate-800">${s.service_name}</h5>
                            <p class="text-sm text-slate-500 my-1">${s.description || ''}</p>
                            <p class="text-sm mt-2">${priceDisplay}</p>
                        </div>`;
                     }).join('');
                } else {
                    servicesContainer.innerHTML = '<p class="text-slate-500">لم تقم هذه العيادة بإضافة قائمة خدماتها بعد.</p>';
                }

                // 4. ملء قائمة الأطباء (بالتصميم الجديد الاحترافي)
                const doctorsContainer = document.getElementById('doctors-list');
                if (data.doctors && data.doctors.length > 0) {
                    doctorsContainer.innerHTML = data.doctors.map(doc => {
                        const rating = parseFloat(doc.avg_rating).toFixed(1);
                        const stars = renderStars(rating, true);
                        return `
                        <div class="doctor-card">
                            <div class="doctor-card-image-wrapper">
                                <img src="${doc.profile_pic || 'uploads/default.png'}" class="doctor-card-image object-top" onerror="this.onerror=null; this.src='uploads/default.png';">
                            </div>
                            <div class="doctor-card-content">
                                <h4 class="text-xl font-bold text-slate-800">${doc.name}</h4>
                                <p class="text-md font-semibold text-sky-600 mb-3">${doc.specialty || 'طبيب عام'}</p>
                                <div class="text-md mb-4">
                                    <span class="font-bold text-amber-500">${rating}</span>
                                    ${stars}
                                    <span class="text-sm text-slate-400">(${doc.review_count} مراجعة)</span>
                                </div>
                                <div class="flex items-center justify-center gap-2 flex-wrap">
                                    <button class="bg-sky-600 text-white px-5 py-2 rounded-full text-sm font-semibold hover:bg-sky-700 opacity-50 cursor-not-allowed">
                                        حجز موعد (قريباً)
                                    </button>
                                    <button class="open-doctor-review-btn bg-white border border-slate-300 text-slate-700 px-5 py-2 rounded-full text-sm font-semibold hover:bg-slate-100" 
                                            data-doc-id="${doc.id}" data-doc-name="${doc.name}">
                                        <i class="fas fa-star text-xs text-amber-500"></i> قيّم الطبيب
                                    </button>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                } else {
                    doctorsContainer.innerHTML = '<p class="text-slate-500">لا يوجد أطباء مضافون لهذه العيادة حالياً.</p>';
                }

                // 5. ملء تقييمات الأطباء
                const docReviewsContainer = document.getElementById('doctor-reviews-list');
                if (data.doctor_reviews && data.doctor_reviews.length > 0) {
                    docReviewsContainer.innerHTML = data.doctor_reviews.map(review => {
                        return `
                        <div class="border-b border-slate-100 pb-3">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-slate-700">${review.customer_name || 'عميل'}</span>
                                ${renderStars(review.rating, true)}
                            </div>
                            <p class="text-xs text-slate-500 mb-2">عن <span class="font-semibold text-sky-700">${review.doctor_name}</span></p>
                            <p class="text-sm text-slate-600">${review.comment || 'لا يوجد تعليق.'}</p>
                        </div>`;
                    }).join('');
                } else {
                    docReviewsContainer.innerHTML = '<p class="text-slate-500 text-sm">لا توجد تقييمات للأطباء بعد.</p>';
                }
                
                // 6. ملء تقييمات العيادة (منفصل)
                const clinicReviewsContainer = document.getElementById('clinic-reviews-list');
                 if (data.clinic_reviews && data.clinic_reviews.length > 0) {
                    clinicReviewsContainer.innerHTML = data.clinic_reviews.map(review => {
                        return `
                        <div class="border-b border-slate-100 pb-3">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-slate-700">${review.customer_name || 'عميل'}</span>
                                ${renderStars(review.rating, true)}
                            </div>
                            <p class="text-sm text-slate-600 mt-2">${review.comment || 'لا يوجد تعليق.'}</p>
                        </div>`;
                    }).join('');
                } else {
                    clinicReviewsContainer.innerHTML = '<p class="text-slate-500 text-sm">لا توجد تقييمات لهذه العيادة بعد.</p>';
                }
                
                // 7. ملء العروض النشطة (محدث)
                const promoBar = document.getElementById('clinic-promotions-bar');
                if (data.promotions && data.promotions.length > 0) {
                    promoBar.classList.remove('hidden');
                    promoBar.innerHTML = data.promotions.map(promo => {
                        const startDateText = promo.start_date 
                            ? `يبدأ من: ${new Date(promo.start_date).toLocaleDateString('ar-EG')} | ` 
                            : 'العرض سارٍ الآن | ';
                            
                        return `
                        <div class="bg-amber-50 border-r-4 border-amber-500 p-4 rounded-lg shadow-sm">
                            <h3 class="font-bold text-amber-800 flex items-center gap-2"><i class="fas fa-bullhorn"></i> ${promo.title}</h3>
                            <p class="text-amber-700 text-sm mt-1">${promo.description}</p>
                            <p class="text-xs text-amber-600 font-semibold mt-2">
                                ${startDateText}
                                ينتهي في: ${new Date(promo.expiry_date).toLocaleDateString('ar-EG')}
                            </p>
                        </div>
                        `;
                    }).join('');
                } 

            } catch (error) {
                console.error('Failed to fetch clinic details:', error);
                clinicContent.classList.add('hidden'); 
                errorContainer.classList.remove('hidden');
                errorContainer.innerHTML = `<h1 class="text-center text-3xl font-bold text-rose-600 p-10">حدث خطأ.</h1><p class="text-center text-slate-600">${error.message}</p>`;
            } finally {
                // إظهار المحتوى وإخفاء التحميل
                preloader.style.opacity = '0';
                setTimeout(() => { preloader.style.display = 'none'; }, 750);
                pageContent.style.opacity = '1';
                pageContent.classList.remove('hidden');
                if(clinicId) clinicContent.classList.remove('hidden');
                bindAllReviewModals(clinicId); 
            }
        }
        
        const urlParamsOnLoad = new URLSearchParams(window.location.search);
        const clinicIdOnLoad = urlParamsOnLoad.get('clinic_id');
        
        if (clinicIdOnLoad) {
            loadClinicData(clinicIdOnLoad);
        } else {
            const preloader = document.getElementById('preloader');
            preloader.style.opacity = '0';
            setTimeout(() => { preloader.style.display = 'none'; }, 750);
            document.getElementById('page-content').classList.remove('hidden');
            document.getElementById('loading-error').classList.remove('hidden');
            document.getElementById('clinic-content-wrapper').classList.add('hidden');
        }

        // ========== كود تشغيل نوافذ التقييم (تم تحديثه ليدعم الاثنين) ==========
        function bindAllReviewModals(clinicId) {
            const clinicReviewForm = document.getElementById('clinic-review-form');
            const clinicReviewMsg = document.getElementById('clinic-review-message');
            
            const doctorModal = document.getElementById('review-modal');
            const doctorReviewForm = document.getElementById('doctor-review-form');
            const closeDocBtn = document.getElementById('close-review-modal');
            const doctorReviewMsg = document.getElementById('doctor-review-message');

            // --- 1. فورم تقييم العيادة (في نفس الصفحة) ---
            if(clinicReviewForm) {
                clinicReviewForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    clinicReviewMsg.classList.add('hidden');
                    const formData = new FormData(clinicReviewForm);
                    const data = {
                        clinic_id: parseInt(clinicId),
                        name: formData.get('name'),
                        rating: parseInt(formData.get('clinic_rating')),
                        comment: formData.get('comment')
                    };

                    if (!data.rating) {
                        showReviewMessage(clinicReviewMsg, 'الرجاء اختيار تقييم (عدد النجوم).', false);
                        return;
                    }

                    try {
                        const result = await sendReview('api/submit_clinic_review.php', data); // <-- API الجديد
                        showReviewMessage(clinicReviewMsg, result.message, true);
                        clinicReviewForm.reset();
                        setTimeout(() => window.location.reload(), 2000); 
                    } catch (error) {
                        showReviewMessage(clinicReviewMsg, error.message, false);
                    }
                });
            }

            // --- 2. فورم تقييم الطبيب (نافذة منبثقة) ---
            const openDoctorModal = (doctorId, doctorName) => {
                doctorReviewForm.reset();
                document.getElementById('review-doctor-id').value = doctorId;
                document.getElementById('review-doctor-name').textContent = doctorName;
                doctorReviewMsg.classList.add('hidden');
                doctorModal.classList.remove('hidden');
                doctorModal.classList.add('flex');
            };
            const closeDoctorModal = () => {
                doctorModal.classList.add('hidden');
                doctorModal.classList.remove('flex');
            };

            document.getElementById('doctors-list').addEventListener('click', (e) => {
                 const btn = e.target.closest('.open-doctor-review-btn');
                 if(btn) {
                     openDoctorModal(btn.dataset.docId, btn.dataset.docName);
                 }
            });

            if(closeDocBtn) closeDocBtn.addEventListener('click', closeDoctorModal);

            if(doctorReviewForm) {
                doctorReviewForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    doctorReviewMsg.classList.add('hidden');
                    const formData = new FormData(doctorReviewForm);
                    const data = {
                        doctor_id: parseInt(formData.get('doctor_id')),
                        name: formData.get('name'),
                        rating: parseInt(formData.get('doctor_rating')),
                        comment: formData.get('comment')
                    };

                    if (!data.rating) {
                        showReviewMessage(doctorReviewMsg, 'الرجاء اختيار تقييم (عدد النجوم).', false);
                        return;
                    }

                    try {
                        const result = await sendReview('api/submit_review.php', data); // <-- API القديم (للأطباء)
                        showReviewMessage(doctorReviewMsg, result.message, true);
                        setTimeout(() => {
                            closeDoctorModal();
                            location.reload(); 
                        }, 2000);
                    } catch (error) {
                        showReviewMessage(doctorReviewMsg, error.message, false);
                    }
                });
            }

            // --- دوال مساعدة للتقييم ---
            async function sendReview(url, data) {
                 const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    return result;
                } else {
                    throw new Error(result.error || 'فشل إرسال التقييم.');
                }
            }

            function showReviewMessage(element, message, isSuccess) {
                element.textContent = message;
                element.className = isSuccess 
                    ? 'text-center font-semibold text-emerald-600 mt-2' 
                    : 'text-center font-semibold text-rose-600 mt-2';
                element.classList.remove('hidden');
            }
        }
    </script>

</body>
</html>